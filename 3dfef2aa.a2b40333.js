(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{190:function(e,t,o){"use strict";o.d(t,"a",(function(){return u})),o.d(t,"b",(function(){return m}));var a=o(0),n=o.n(a);function r(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function s(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function i(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?s(Object(o),!0).forEach((function(t){r(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):s(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function l(e,t){if(null==e)return{};var o,a,n=function(e,t){if(null==e)return{};var o,a,n={},r=Object.keys(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||(n[o]=e[o]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}var c=n.a.createContext({}),p=function(e){var t=n.a.useContext(c),o=t;return e&&(o="function"==typeof e?e(t):i(i({},t),e)),o},u=function(e){var t=p(e.components);return n.a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.a.createElement(n.a.Fragment,{},t)}},h=n.a.forwardRef((function(e,t){var o=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(o),h=a,m=u["".concat(s,".").concat(h)]||u[h]||d[h]||r;return o?n.a.createElement(m,i(i({ref:t},c),{},{components:o})):n.a.createElement(m,i({ref:t},c))}));function m(e,t){var o=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=o.length,s=new Array(r);s[0]=h;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:a,s[1]=i;for(var c=2;c<r;c++)s[c]=o[c];return n.a.createElement.apply(null,s)}return n.a.createElement.apply(null,o)}h.displayName="MDXCreateElement"},93:function(e,t,o){"use strict";o.r(t),o.d(t,"frontMatter",(function(){return s})),o.d(t,"metadata",(function(){return i})),o.d(t,"rightToc",(function(){return l})),o.d(t,"default",(function(){return p}));var a=o(2),n=o(6),r=(o(0),o(190)),s={slug:"why-i-wrote-my-own-state-management-for-react-virtuoso",title:"Why I wrote my own state management for react virtuoso",author:"Petyo Ivanov",author_url:"https://github.com/petyosi",author_image_url:"https://avatars0.githubusercontent.com/u/13347?s=400&u=9d34329f37c378cb3cd2647e301b2344ef534071&v=4",tags:["urx","state-management"]},i={permalink:"/blog/why-i-wrote-my-own-state-management-for-react-virtuoso",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/blog/blog/2020-12-13-own-state-management.md",source:"@site/blog/2020-12-13-own-state-management.md",description:"Almost 2 years after its first release, last Saturday I shipped v1.0.0 of React Virtuoso. With this release, the state management framework powering Virtuoso is now available as a separate package called urx,",date:"2020-12-13T00:00:00.000Z",tags:[{label:"urx",permalink:"/blog/tags/urx"},{label:"state-management",permalink:"/blog/tags/state-management"}],title:"Why I wrote my own state management for react virtuoso",readingTime:7.18,truncated:!1},l=[{value:"Virtuoso is not your Typical React App",id:"virtuoso-is-not-your-typical-react-app",children:[{value:"Initial Prototype - the Redux-based Failure",id:"initial-prototype---the-redux-based-failure",children:[]},{value:"Second Attempt - Hooks",id:"second-attempt---hooks",children:[]},{value:"Third Pass - RxJS to the Rescue",id:"third-pass---rxjs-to-the-rescue",children:[]}]},{value:"Fast Forward One Year - Virtuoso is Used for Chats and Feeds",id:"fast-forward-one-year---virtuoso-is-used-for-chats-and-feeds",children:[]},{value:"urx was Born",id:"urx-was-born",children:[]},{value:"The Result",id:"the-result",children:[]},{value:"It&#39;s not all Roses, but it&#39;s Worth it",id:"its-not-all-roses-but-its-worth-it",children:[]},{value:"Should you try urx?",id:"should-you-try-urx",children:[]}],c={rightToc:l};function p(e){var t=e.components,o=Object(n.a)(e,["components"]);return Object(r.b)("wrapper",Object(a.a)({},c,o,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"Almost 2 years after its first release, last Saturday I shipped ",Object(r.b)("inlineCode",{parentName:"p"},"v1.0.0")," of ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://virtuoso.dev/"}),"React Virtuoso"),". With this release, the state management framework powering Virtuoso is now available as a separate package called urx,\nwith its own documentation and examples available at ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://urx.virtuoso.dev/"}),"urx.virtuoso.dev"),".This is the story of what brought the development of the project there."),Object(r.b)("h2",{id:"virtuoso-is-not-your-typical-react-app"},"Virtuoso is not your Typical React App"),Object(r.b)("p",null,"The popular React state management solutions are designed with the app in mind - a relatively large data tree with reducers rebuilding certain parts of it. Managing the state of the Virtuoso component is a different kind of problem.\nIn its case, a multitude of ",Object(r.b)("strong",{parentName:"p"},"continuously changing input values"),' from the DOM combine with the component properties into a relatively simple data structure - a list of items "windowed" to show the currently visible part of a large list. Here\'s a pseudo-code representation of what the state calculation looks like:'),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"// DOM input\ntop = dom.scrollTop\nheight = dom.viewportHeight\nsizes = dom.itemSizes\n\n// component properties\ncount = props.totalCount\noverscan = props.overscan\ndata = props.data\ngroups = props.groups\n\n// ... intermediate calculations\nsizeTree = rebuildSizeTree(sizeTree, sizes, count)\nlistRange = rebuildWindow(top, height, overscan, listDimensions)\nlist = items(listRange, sizeTree)\nlistDimensions = dimensions(list)\n\n// output of a list \n[paddingTop, paddingBottom] = dimensions(list)\nitems = buildItems(list, data, groups)\n")),Object(r.b)("p",null,"Here's the catch - none of the dom/props above is a static value. They are ",Object(r.b)("strong",{parentName:"p"},"streams of changing values")," which should be efficiently propagated through the list/item calculation logic. The change propagation cannot be described efficiently with procedural code - you need a topology of dependencies."),Object(r.b)("h3",{id:"initial-prototype---the-redux-based-failure"},"Initial Prototype - the Redux-based Failure"),Object(r.b)("p",null,"My initial prototype of the component was Redux based.\nThe good news was that the idea of using ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/petyosi/react-virtuoso/blob/master/src/AATree.ts"}),"a binary tree structure")," for the item sizes worked.The bad news was that either I did not understand Redux or it was the incorrect tool for what I was doing. My code was a ",Object(r.b)("strong",{parentName:"p"},"pile of interdependent reducers")," that were repeatedly called with various combinations of values from actions and the existing state. "),Object(r.b)("p",null,Object(r.b)("img",Object(a.a)({parentName:"p"},{src:"https://virtuoso.dev/img/blog/spaghetti.jpg",alt:null}))),Object(r.b)("p",null,Object(r.b)("small",null,"An artistic interpretation of Virtuoso's Redux implementation. ",Object(r.b)("span",null,"Photo by ",Object(r.b)("a",{href:"https://unsplash.com/@behy_studio?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText"},"Behnam Norouzi")," on ",Object(r.b)("a",{href:"https://unsplash.com/s/photos/spaghetti?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText"},"Unsplash")),".")),Object(r.b)("h3",{id:"second-attempt---hooks"},"Second Attempt - Hooks"),Object(r.b)("p",null,"Unsurprisingly, re-implementing the idea with hooks did not make it better. In fact, it looked like a step in the wrong direction, because the Redux implementation was at least easily unit-testable outside of React. I threw the spaghetti away and took a short break from the idea."),Object(r.b)("h3",{id:"third-pass---rxjs-to-the-rescue"},"Third Pass - RxJS to the Rescue"),Object(r.b)("p",null,'Staring at the code, I noticed the stream pattern. The scroll container was continuously "emitting" ',Object(r.b)("inlineCode",{parentName:"p"},"scrollTop")," values. The viewport emitted its height when resizing. The list items emitted their sizes when rendering or when resizing. Squinting a little bit, even the values of the component properties looked like streams of changing values. Could those values be wrapped ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.learnrxjs.io/learn-rxjs/concepts/rxjs-primer#what-is-an-observable"}),"into RxJS Observables"),"? "),Object(r.b)("p",null,"The next implementation of Virtuoso was a bag of ",Object(r.b)("strong",{parentName:"p"},"input observables")," that got combined and transformed to produce ",Object(r.b)("strong",{parentName:"p"},"output observables"),'. The observables were put in a context, and wired up to "dumb" React components through ',Object(r.b)("inlineCode",{parentName:"p"},"useInput(observable$)")," / ",Object(r.b)("inlineCode",{parentName:"p"},"useOutput(observable$)"),"\npair of hooks that either pushed into the specified observable or re-rendered in response to a new value being emitted."),Object(r.b)("p",null,"This approach was an enormous improvement. Handing updates through the ",Object(r.b)("inlineCode",{parentName:"p"},"combineLatest")," and ",Object(r.b)("inlineCode",{parentName:"p"},"withLatestFrom")," operators eliminated the duplication from the Redux actions. The observable combinatory logic was easily testable outside of React. Finally, rather than dealing with a state tree, I subscribe to the output observables I needed in the specific component, optimizing its rendering. "),Object(r.b)("p",null,Object(r.b)("img",Object(a.a)({parentName:"p"},{src:"https://virtuoso.dev/img/blog/pipes.jpg",alt:null}))),Object(r.b)("p",null,Object(r.b)("small",null,"Observables felt like a well organized, permanent piping and transformation system of the component state. ",Object(r.b)("span",null,"Photo by ",Object(r.b)("a",{href:"https://unsplash.com/@hooverpaul55?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText"},"Paul Teysen")," on ",Object(r.b)("a",{href:"https://unsplash.com/s/photos/complex-pipes?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText"},"Unsplash")),".")),Object(r.b)("p",null,"Building Virtuoso was fun again. The version which I mustered the courage to announce to the world was built on top of RxJS - and it got a fairly positive response in ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.reddit.com/r/reactjs/comments/bp7ub6/react_virtuoso_a_virtual_scrolling_library_with/"}),"/r/reactjs"),".\nA few redditors noticed the RxJS dependency, but nobody called me out on the state management blasphemy I have created. Instead, they complained about the bundle size. RxJS was too large for a small UI component. And they were right."),Object(r.b)("p",null,"This problem was not unsolvable, because I used a very small part of RxJS. Over the weekend, I whipped a home-grown implementation of what I was using from RxJS and threw it in a cheekily named ",Object(r.b)("inlineCode",{parentName:"p"},"tinyrx.ts"),". The RxJS dependency was gone and the package was down to 7kB according to Bundlephobia. In hindsight, doing that replacement back then was the right choice. Doing that at a later stage would not be that easy."),Object(r.b)("h2",{id:"fast-forward-one-year---virtuoso-is-used-for-chats-and-feeds"},"Fast Forward One Year - Virtuoso is Used for Chats and Feeds"),Object(r.b)("p",null,"The problem solved by Virtuoso (easy virtualization of variably sized items) was hard enough for the project to attract and retain supportive (and smart!) early adopters - who endured my poor understanding of React\nand educated me on the finer arts of improving React performance (shoutout to ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/FezVrasta"}),"Federico Zivolo a.k.a. FezVrasta"),"). "),Object(r.b)("p",null,"I also understood a lot more about my users and their virtual lists. Many of them were building ",Object(r.b)("strong",{parentName:"p"},"chats and data feeds")," - a use case which can be best described as a ",Object(r.b)("strong",{parentName:"p"},"reverse endless scrolling"),". Reverse scrolling was a problem that I originally did not intend to address. And the business as usual new features overburdened my naive ",Object(r.b)("inlineCode",{parentName:"p"},"VirtuosoStore")," implementation, a single JS function that initiated and combined the entire set of observables used in the component. The project needed a rewrite to move forward."),Object(r.b)("p",null,Object(r.b)("img",Object(a.a)({parentName:"p"},{src:"https://virtuoso.dev/img/blog/subjects-are-signals.jpg",alt:null}))),Object(r.b)("p",null,Object(r.b)("small",null,"My fellow developers had more than enough of me explaining why observables made sense in React.")),Object(r.b)("h2",{id:"urx-was-born"},"urx was Born"),Object(r.b)("p",null,"As these things go, I fell in love with my pet reactive state management pattern, so I decided to give it its own name and proper documentation. It also grew up a bit and got some original looks. Rather than just being a poor man's RxJS, the urx library includes the ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://urx.virtuoso.dev/docs/api/modules/_urx_src_system_"}),"systems abstraction")," as a way to organize Observables into testable components.\nSubjects and Behavior Subjects (the names of which I find highly confusing) are renamed ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://urx.virtuoso.dev/docs/api/modules/_urx_src_streams_"}),"to streams and stateful streams"),".\nThe React abstraction got its own package, dedicated to the magical transformation of an ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://urx.virtuoso.dev/docs/api/modules/_react_urx_src_index_"}),"urx system into a React component"),". "),Object(r.b)("h2",{id:"the-result"},"The Result"),Object(r.b)("p",null,"React Virtuoso consists of 1550 lines of code in framework-agnostic urx systems, wrapped up in ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/petyosi/react-virtuoso/blob/master/src/List.tsx"}),"~200 lines of dumb react components"),' wired up to the "master" List system. The react code is downright boring - the only unit tests against it are mostly checking the server-side-rendering specifics. The ',Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/petyosi/react-virtuoso/tree/master/test"}),"rest of the test suite")," is written against the various urx systems. As an example, here's how the ",Object(r.b)("inlineCode",{parentName:"p"},"domIOSystem")," looks: "),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ts"}),"import { connect, pipe, scan, map, system, stream, statefulStream } from '@virtuoso.dev/urx'\n\nexport const UP = 'up' as const\nexport const DOWN = 'down' as const\nexport type ScrollDirection = typeof UP | typeof DOWN\n\nexport const domIOSystem = system(\n  () => {\n    const scrollTop = stream<number>()\n    const deviation = statefulStream(0)\n    const smoothScrollTargetReached = stream<true>()\n    const statefulScrollTop = statefulStream(0)\n    const viewportHeight = stream<number>()\n    const scrollTo = stream<ScrollToOptions>()\n    const scrollBy = stream<ScrollToOptions>()\n\n    connect(scrollTop, statefulScrollTop)\n    const scrollDirection = statefulStream<ScrollDirection>(DOWN)\n\n    connect(\n      pipe(\n        scrollTop,\n        scan(\n          (acc, scrollTop) => {\n            return { direction: scrollTop < acc.prevScrollTop ? UP : DOWN, prevScrollTop: scrollTop }\n          },\n          { direction: DOWN, prevScrollTop: 0 } as { direction: ScrollDirection; prevScrollTop: number }\n        ),\n        map(value => value.direction)\n      ),\n      scrollDirection\n    )\n\n    return {\n      // input\n      scrollTop,\n      viewportHeight,\n      smoothScrollTargetReached,\n\n      // signals\n      scrollTo,\n      scrollBy,\n\n      // state\n      scrollDirection,\n      statefulScrollTop,\n      deviation,\n    }\n  },\n  [],\n  { singleton: true }\n)\n")),Object(r.b)("p",null,"The component implementation is quite portable; when React goes out of fashion, the underlying stream system can be wrapped in a different UI framework. "),Object(r.b)("h2",{id:"its-not-all-roses-but-its-worth-it"},"It's not all Roses, but it's Worth it"),Object(r.b)("p",null,"Reactive programming is not a silver bullet, nor magic fairly land where your code has no bugs. At some point, the ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://en.wikipedia.org/wiki/Reactive_programming#Implementation_challenges_in_reactive_programming"}),"Reactive Programming Wikipedia Article Implementation Challenges"),"\nbecame a checklist of the errors and the subtle issues I encountered. React, while perceptive to the approach, is also not explicitly designed to work with observable streams. "),Object(r.b)("p",null,"Still, I am certain that I could not implement React Virtuoso with any other state management. "),Object(r.b)("h2",{id:"should-you-try-urx"},"Should you try urx?"),Object(r.b)("p",null,'The short answer is probably "no" unless you are implementing something similar to React Virtuoso. The popular state management tools have enormous healthy ecosystems, documentation, and tooling built for them. '),Object(r.b)("p",null,"However, you can go ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://urx.virtuoso.dev/"}),"through the documentation")," even for the fun of it - it is a different take on UI state management. If you want to see a real-world example of how systems are built and organized, you can dig into ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/petyosi/react-virtuoso/tree/master/src"}),"the source code of React Virtuoso itself"),". "))}p.isMDXComponent=!0}}]);